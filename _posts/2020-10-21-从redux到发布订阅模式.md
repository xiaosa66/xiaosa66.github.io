## redux åŸºæœ¬æ¦‚å¿µ

### Store

äººå¦‚å…¶åï¼ŒStoreå°±æ˜¯ä¸€ä¸ªä»“åº“ï¼Œå®ƒå­˜å‚¨äº†æ‰€æœ‰çš„çŠ¶æ€(State)ï¼Œè¿˜æä¾›äº†ä¸€äº›æ“ä½œä»–çš„APIï¼Œæˆ‘ä»¬åç»­çš„æ“ä½œå…¶å®éƒ½æ˜¯åœ¨æ“ä½œè¿™ä¸ªä»“åº“ã€‚å‡å¦‚æˆ‘ä»¬çš„ä»“åº“æ˜¯ç”¨æ¥æ”¾ç‰›å¥¶çš„ï¼Œåˆå§‹æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ä»“åº“é‡Œé¢ä¸€ç®±ç‰›å¥¶éƒ½æ²¡æœ‰ã€‚é‚£Storeçš„çŠ¶æ€(State)å°±æ˜¯ï¼š

```JS
{
	milk: 0
}
```

### Actions

ä¸€ä¸ªActionå°±æ˜¯ä¸€ä¸ªåŠ¨ä½œï¼Œè¿™ä¸ªåŠ¨ä½œçš„ç›®çš„æ˜¯æ›´æ”¹Storeä¸­çš„æŸä¸ªçŠ¶æ€ï¼ŒStoreè¿˜æ˜¯ä¸Šé¢çš„é‚£ä¸ªä»“åº“ï¼Œç°åœ¨æˆ‘æƒ³å¾€ä»“åº“æ”¾ä¸€ç®±ç‰›å¥¶ï¼Œé‚£"æˆ‘æƒ³å¾€ä»“åº“æ”¾ä¸€ç®±ç‰›å¥¶"å°±æ˜¯ä¸€ä¸ªActionã€‚ä»£ç å°±æ˜¯è¿™æ ·ï¼š
```JS
{
  type: "PUT_MILK",
  count: 1
}
```

### Reducers
å‰é¢"æˆ‘æƒ³å¾€ä»“åº“æ”¾ä¸€ç®±ç‰›å¥¶"åªæ˜¯æƒ³äº†ï¼Œè¿˜æ²¡æ“ä½œï¼Œå…·ä½“æ“ä½œè¦é Reducerï¼ŒReducerå°±æ˜¯æ ¹æ®æ¥æ”¶çš„Actionæ¥æ”¹å˜Storeä¸­çš„çŠ¶æ€ï¼Œæ¯”å¦‚æˆ‘æ¥æ”¶äº†ä¸€ä¸ªPUT_MILKï¼ŒåŒæ—¶æ•°é‡countæ˜¯1ï¼Œé‚£æ”¾è¿›å»çš„ç»“æœå°±æ˜¯milkå¢åŠ äº†1ï¼Œä»0å˜æˆäº†1ï¼Œä»£ç å°±æ˜¯è¿™æ ·:
```js
const initState = {
  milk: 0
}

function reducer(state = initState, action) {
  switch (action.type) {
    case 'PUT_MILK':
      return {...state, milk: state.milk + action.count}
    default:
      return state
  }
}
```

å¯ä»¥çœ‹åˆ°Reduxæœ¬èº«å°±æ˜¯ä¸€ä¸ªå•çº¯çš„çŠ¶æ€æœºï¼ŒStoreå­˜æ”¾äº†æ‰€æœ‰çš„çŠ¶æ€ï¼ŒActionæ˜¯ä¸€ä¸ªæ”¹å˜çŠ¶æ€çš„é€šçŸ¥ï¼ŒReduceræ¥æ”¶åˆ°é€šçŸ¥å°±æ›´æ”¹Storeä¸­å¯¹åº”çš„çŠ¶æ€ã€‚


------

## é€šè¿‡æ‰‹å†™reduxç†è§£redux


### APIï¼šcreateStore 

è¿™é‡Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªä½¿ç”¨reduxçš„ä¾‹å­ åœ¨åé¢æˆ‘ä»¬æ›¿æ¢ä¸ºè‡ªå·±æ‰‹å†™çš„redux

```js
import { createStore } from 'redux';

const initState = {
  milk: 0
};

function reducer(state = initState, action) {
  switch (action.type) {
    case 'PUT_MILK':
      return {...state, milk: state.milk + action.count};
    case 'TAKE_MILK':
      return {...state, milk: state.milk - action.count};
    default:
      return state;
  }
}

let store = createStore(reducer);

// subscribeå…¶å®å°±æ˜¯è®¢é˜…storeçš„å˜åŒ–ï¼Œä¸€æ—¦storeå‘ç”Ÿäº†å˜åŒ–ï¼Œä¼ å…¥çš„å›è°ƒå‡½æ•°å°±ä¼šè¢«è°ƒç”¨
// å¦‚æœæ˜¯ç»“åˆé¡µé¢æ›´æ–°ï¼Œæ›´æ–°çš„æ“ä½œå°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œ
store.subscribe(() => console.log(store.getState()));

// å°†actionå‘å‡ºå»è¦ç”¨dispatch
store.dispatch({ type: 'PUT_MILK' });    // milk: 1
store.dispatch({ type: 'PUT_MILK' });    // milk: 2
store.dispatch({ type: 'TAKE_MILK' });   // milk: 1
```
åœ¨ä¸Šæ–‡çš„ä¾‹å­ä¸­ æˆ‘ä»¬åªç”¨åˆ°äº†ä¸€ä¸ªAPI

createStoreï¼šè¿™ä¸ªAPIæ¥å—reduceræ–¹æ³•ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªstoreï¼Œä¸»è¦åŠŸèƒ½éƒ½åœ¨è¿™ä¸ªstoreä¸Šã€‚

çœ‹çœ‹storeä¸Šæˆ‘ä»¬éƒ½ç”¨åˆ°äº†å•¥ï¼š

store.subscribe: è®¢é˜…stateçš„å˜åŒ–ï¼Œå½“stateå˜åŒ–çš„æ—¶å€™æ‰§è¡Œå›è°ƒï¼Œå¯ä»¥æœ‰å¤šä¸ªsubscribeï¼Œé‡Œé¢çš„å›è°ƒä¼šä¾æ¬¡æ‰§è¡Œã€‚

store.dispatch: å‘å‡ºactionçš„æ–¹æ³•ï¼Œæ¯æ¬¡dispatch actionéƒ½ä¼šæ‰§è¡Œreducerç”Ÿæˆæ–°çš„stateï¼Œç„¶åæ‰§è¡Œsubscribeæ³¨å†Œçš„å›è°ƒã€‚

store.getState:ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œè¿”å›å½“å‰çš„stateã€‚

çœ‹åˆ°subscribeæ³¨å†Œå›è°ƒï¼Œdispatchè§¦å‘å›è°ƒ. è¿™å°±æ˜¯å…¸å‹çš„å‘å¸ƒè®¢é˜…æ¨¡å¼.åé¢èŠèŠå‘å¸ƒè®¢é˜…æ¨¡å¼.

```js
function createStore() {
  let state;              // stateè®°å½•æ‰€æœ‰çŠ¶æ€
  let listeners = [];     // ä¿å­˜æ‰€æœ‰æ³¨å†Œçš„å›è°ƒ

  function subscribe(callback) {
    listeners.push(callback);       // subscribeå°±æ˜¯å°†å›è°ƒä¿å­˜ä¸‹æ¥
  }

  // dispatchå°±æ˜¯å°†æ‰€æœ‰çš„å›è°ƒæ‹¿å‡ºæ¥ä¾æ¬¡æ‰§è¡Œå°±è¡Œ

  function dispatch(action) {
    /**
    * reducerçš„ä½œç”¨æ˜¯åœ¨å‘å¸ƒäº‹ä»¶çš„æ—¶å€™æ”¹å˜stateï¼Œ
    * æ‰€ä»¥æˆ‘ä»¬çš„dispatchåœ¨æ‰§è¡Œå›è°ƒå‰åº”è¯¥å…ˆæ‰§è¡Œreducer,
    * ç”¨reducerçš„è¿”å›å€¼é‡æ–°ç»™stateèµ‹å€¼
    */
    state = reducer(state, action);
    // æ”¹å˜çŠ¶æ€åæ‰§è¡Œè®¢é˜…çš„callback
    for (let i = 0; i < listeners.length; i++) {
      const listener = listeners[i];
      listener();
    }
  }
  // getStateç›´æ¥è¿”å›state
  function getState() {
    return state;
  }

  // storeåŒ…è£…ä¸€ä¸‹å‰é¢çš„æ–¹æ³•ç›´æ¥è¿”å›
  const store = {
    subscribe,
    dispatch,
    getState
  }

  return store;
}
```


### API:combineReducers

combineReducersä¹Ÿæ˜¯ä½¿ç”¨éå¸¸å¹¿æ³›çš„APIï¼Œå½“æˆ‘ä»¬åº”ç”¨è¶Šæ¥è¶Šå¤æ‚ï¼Œå¦‚æœå°†æ‰€æœ‰é€»è¾‘éƒ½å†™åœ¨ä¸€ä¸ªreduceré‡Œé¢ï¼Œæœ€ç»ˆè¿™ä¸ªæ–‡ä»¶å¯èƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡è¡Œï¼Œæ‰€ä»¥Reduxæä¾›äº†combineReducersï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸ºä¸åŒçš„æ¨¡å—å†™è‡ªå·±çš„reducerï¼Œæœ€ç»ˆå°†ä»–ä»¬ç»„åˆèµ·æ¥ã€‚æ¯”å¦‚æˆ‘ä»¬æœ€å¼€å§‹é‚£ä¸ªç‰›å¥¶ä»“åº“ï¼Œç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡å‘å±•å¾ˆå¥½ï¼Œæˆ‘ä»¬åˆå¢åŠ äº†ä¸€ä¸ªæ”¾å¤§ç±³çš„ä»“åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¿™ä¸¤ä¸ªä»“åº“åˆ›å»ºè‡ªå·±çš„reducer

```js
import { createStore, combineReducers } from 'redux';

const initMilkState = {
  milk: 0
};
function milkReducer(state = initMilkState, action) {
  switch (action.type) {
    case 'PUT_MILK':
      return {...state, milk: state.milk + action.count};
    case 'TAKE_MILK':
      return {...state, milk: state.milk - action.count};
    default:
      return state;
  }
}

const initRiceState = {
  rice: 0
};
function riceReducer(state = initRiceState, action) {
  switch (action.type) {
    case 'PUT_RICE':
      return {...state, rice: state.rice + action.count};
    case 'TAKE_RICE':
      return {...state, rice: state.rice - action.count};
    default:
      return state;
  }
}

// ä½¿ç”¨combineReducersç»„åˆä¸¤ä¸ªreducer
const reducer = combineReducers({milkState: milkReducer, riceState: riceReducer});

let store = createStore(reducer);

store.subscribe(() => console.log(store.getState()));

// æ“ä½œğŸ¥›çš„action
store.dispatch({ type: 'PUT_MILK', count: 1 });    // milk: 1
store.dispatch({ type: 'PUT_MILK', count: 1 });    // milk: 2
store.dispatch({ type: 'TAKE_MILK', count: 1 });   // milk: 1

// æ“ä½œå¤§ç±³çš„action
store.dispatch({ type: 'PUT_RICE', count: 1 });    // rice: 1
store.dispatch({ type: 'PUT_RICE', count: 1 });    // rice: 2
store.dispatch({ type: 'TAKE_RICE', count: 1 });   // rice: 1
```


åœ¨ä¸Šé¢ æˆ‘ä»¬æ–°å»ºäº†ä¸¤ä¸ªstateï¼Œé€šè¿‡combineReducersæ¥æ”¶è¿™ä¸¤ä¸ªreducerå¹¶è¿”å›ä¸€ä¸ªæ–°çš„reducerã€‚è®©æˆ‘ä»¬å°è¯•å®ç°ä¸€ä¸‹ï¼š

```js
function combineReducers(reducerMap) {
  const reducerKeys = Object.keys(reducerMap);    // å…ˆæŠŠå‚æ•°é‡Œé¢æ‰€æœ‰çš„é”®å€¼æ‹¿å‡ºæ¥
  
  // è¿”å›å€¼æ˜¯ä¸€ä¸ªæ™®é€šç»“æ„çš„reducerå‡½æ•°
  const reducer = (state = {}, action) => {
    const newState = {};
    
    for(let i = 0; i < reducerKeys.length; i++) {
      // reducerMapé‡Œé¢æ¯ä¸ªé”®çš„å€¼éƒ½æ˜¯ä¸€ä¸ªreducerï¼Œæˆ‘ä»¬æŠŠå®ƒæ‹¿å‡ºæ¥è¿è¡Œä¸‹å°±å¯ä»¥å¾—åˆ°å¯¹åº”é”®æ–°çš„stateå€¼
      // ç„¶åå°†æ‰€æœ‰reducerè¿”å›çš„stateæŒ‰ç…§å‚æ•°é‡Œé¢çš„keyç»„è£…å¥½
      // æœ€åå†è¿”å›ç»„è£…å¥½çš„newStateå°±è¡Œ
      const key = reducerKeys[i];
      const currentReducer = reducerMap[key];
      const prevState = state[key];
      newState[key] = currentReducer(prevState, action);
    }
    
    return newState;
  };
  
  return reducer;
}
```

### API:applyMiddleware
middlewareæ˜¯Reduxé‡Œé¢å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒReduxçš„ç”Ÿæ€ä¸»è¦é è¿™ä¸ªAPIæ¥å…¥ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³å†™ä¸€ä¸ªloggerçš„ä¸­é—´ä»¶å¯ä»¥è¿™æ ·å†™(è¿™ä¸ªä¸­é—´ä»¶æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£)ï¼š

```js
// loggeræ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ³¨æ„è¿”å›å€¼åµŒäº†å¥½å‡ å±‚å‡½æ•°
// æˆ‘ä»¬åé¢æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡
function logger(store) {
  return function(next) {
    return function(action) {
      console.group(action.type);
      console.info('dispatching', action);
      let result = next(action);
      console.log('next state', store.getState());
      console.groupEnd();
      return result
    }
  }
}

// åœ¨createStoreçš„æ—¶å€™å°†applyMiddlewareä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ è¿›å»
const store = createStore(
  reducer,
  applyMiddleware(logger)
)
```

åœ¨è¿™é‡ŒcreateStoreä¼ å…¥äº†ç¬¬äºŒä¸ªå‚æ•° å®˜æ–¹ç®¡è¿™ä¸ªå«åš enhancer ï¼Œenhancerä½œä¸ºä¸€ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªstoreCreaterå¹¶è¿”å›ä¸€ä¸ªstoreCreaterã€‚

è®©æˆ‘ä»¬æ›´æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„createStoreä½¿ä¹‹å¯ä»¥å¤„ç†ç¬¬äºŒä¸ªå‚æ•° ä¹Ÿå°±æ˜¯enhancerã€‚

```js

function createStore(reducer, enhancer) {   // æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•°enhancer
  // å…ˆå¤„ç†enhancer
  // å¦‚æœenhancerå­˜åœ¨å¹¶ä¸”æ˜¯å‡½æ•°
  // æˆ‘ä»¬å°†createStoreä½œä¸ºå‚æ•°ä¼ ç»™ä»–
  // ä»–åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„createStoreç»™æˆ‘
  // æˆ‘å†æ‹¿è¿™ä¸ªæ–°çš„createStoreæ‰§è¡Œï¼Œåº”è¯¥å¾—åˆ°ä¸€ä¸ªstore
  // ç›´æ¥è¿”å›è¿™ä¸ªstoreå°±è¡Œ
  if(enhancer && typeof enhancer === 'function'){
    const newCreateStore = enhancer(createStore);
    const newStore = newCreateStore(reducer);
    return newStore;
  }
  
  // å¦‚æœæ²¡æœ‰enhanceræˆ–è€…enhancerä¸æ˜¯å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œä¹‹å‰çš„é€»è¾‘
  // ä¸‹é¢è¿™äº›ä»£ç éƒ½æ˜¯ä¹‹å‰é‚£ç‰ˆ
  // çœç•¥nè¡Œä»£ç 
	// .......
  const store = {
    subscribe,
    dispatch,
    getState
  }

  return store;
}

```
-----

æœ€åæˆ‘ä»¬å†æ¥æ¢³ç†ä¸‹Reduxçš„æ ¸å¿ƒæµç¨‹ï¼Œæ³¨æ„å•çº¯çš„Reduxåªæ˜¯ä¸ªçŠ¶æ€æœºï¼Œæ˜¯æ²¡æœ‰Viewå±‚çš„ã€‚

<img src="../img/2020-10/redux-data-flow.png" />



