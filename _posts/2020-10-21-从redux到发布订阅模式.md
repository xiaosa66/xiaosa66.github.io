## redux åŸºæœ¬æ¦‚å¿µ

### Store

äººå¦‚å…¶åï¼ŒStoreå°±æ˜¯ä¸€ä¸ªä»“åº“ï¼Œå®ƒå­˜å‚¨äº†æ‰€æœ‰çš„çŠ¶æ€(State)ï¼Œè¿˜æä¾›äº†ä¸€äº›æ“ä½œä»–çš„APIï¼Œæˆ‘ä»¬åç»­çš„æ“ä½œå…¶å®éƒ½æ˜¯åœ¨æ“ä½œè¿™ä¸ªä»“åº“ã€‚å‡å¦‚æˆ‘ä»¬çš„ä»“åº“æ˜¯ç”¨æ¥æ”¾ç‰›å¥¶çš„ï¼Œåˆå§‹æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ä»“åº“é‡Œé¢ä¸€ç®±ç‰›å¥¶éƒ½æ²¡æœ‰ã€‚é‚£Storeçš„çŠ¶æ€(State)å°±æ˜¯ï¼š

```JS
{
	milk: 0
}
```

### Actions

ä¸€ä¸ªActionå°±æ˜¯ä¸€ä¸ªåŠ¨ä½œï¼Œè¿™ä¸ªåŠ¨ä½œçš„ç›®çš„æ˜¯æ›´æ”¹Storeä¸­çš„æŸä¸ªçŠ¶æ€ï¼ŒStoreè¿˜æ˜¯ä¸Šé¢çš„é‚£ä¸ªä»“åº“ï¼Œç°åœ¨æˆ‘æƒ³å¾€ä»“åº“æ”¾ä¸€ç®±ç‰›å¥¶ï¼Œé‚£"æˆ‘æƒ³å¾€ä»“åº“æ”¾ä¸€ç®±ç‰›å¥¶"å°±æ˜¯ä¸€ä¸ªActionã€‚ä»£ç å°±æ˜¯è¿™æ ·ï¼š
```JS
{
  type: "PUT_MILK",
  count: 1
}
```

### Reducers
å‰é¢"æˆ‘æƒ³å¾€ä»“åº“æ”¾ä¸€ç®±ç‰›å¥¶"åªæ˜¯æƒ³äº†ï¼Œè¿˜æ²¡æ“ä½œï¼Œå…·ä½“æ“ä½œè¦é Reducerï¼ŒReducerå°±æ˜¯æ ¹æ®æ¥æ”¶çš„Actionæ¥æ”¹å˜Storeä¸­çš„çŠ¶æ€ï¼Œæ¯”å¦‚æˆ‘æ¥æ”¶äº†ä¸€ä¸ªPUT_MILKï¼ŒåŒæ—¶æ•°é‡countæ˜¯1ï¼Œé‚£æ”¾è¿›å»çš„ç»“æœå°±æ˜¯milkå¢åŠ äº†1ï¼Œä»0å˜æˆäº†1ï¼Œä»£ç å°±æ˜¯è¿™æ ·:
```js
const initState = {
  milk: 0
}

function reducer(state = initState, action) {
  switch (action.type) {
    case 'PUT_MILK':
      return {...state, milk: state.milk + action.count}
    default:
      return state
  }
}
```

å¯ä»¥çœ‹åˆ°Reduxæœ¬èº«å°±æ˜¯ä¸€ä¸ªå•çº¯çš„çŠ¶æ€æœºï¼ŒStoreå­˜æ”¾äº†æ‰€æœ‰çš„çŠ¶æ€ï¼ŒActionæ˜¯ä¸€ä¸ªæ”¹å˜çŠ¶æ€çš„é€šçŸ¥ï¼ŒReduceræ¥æ”¶åˆ°é€šçŸ¥å°±æ›´æ”¹Storeä¸­å¯¹åº”çš„çŠ¶æ€ã€‚


------

## é€šè¿‡æ‰‹å†™reduxç†è§£redux


### APIï¼šcreateStore 

è¿™é‡Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªä½¿ç”¨reduxçš„ä¾‹å­ åœ¨åé¢æˆ‘ä»¬æ›¿æ¢ä¸ºè‡ªå·±æ‰‹å†™çš„redux

```js
import { createStore } from 'redux';

const initState = {
  milk: 0
};

function reducer(state = initState, action) {
  switch (action.type) {
    case 'PUT_MILK':
      return {...state, milk: state.milk + action.count};
    case 'TAKE_MILK':
      return {...state, milk: state.milk - action.count};
    default:
      return state;
  }
}

let store = createStore(reducer);

// subscribeå…¶å®å°±æ˜¯è®¢é˜…storeçš„å˜åŒ–ï¼Œä¸€æ—¦storeå‘ç”Ÿäº†å˜åŒ–ï¼Œä¼ å…¥çš„å›è°ƒå‡½æ•°å°±ä¼šè¢«è°ƒç”¨
// å¦‚æœæ˜¯ç»“åˆé¡µé¢æ›´æ–°ï¼Œæ›´æ–°çš„æ“ä½œå°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œ
store.subscribe(() => console.log(store.getState()));

// å°†actionå‘å‡ºå»è¦ç”¨dispatch
store.dispatch({ type: 'PUT_MILK' });    // milk: 1
store.dispatch({ type: 'PUT_MILK' });    // milk: 2
store.dispatch({ type: 'TAKE_MILK' });   // milk: 1
```
åœ¨ä¸Šæ–‡çš„ä¾‹å­ä¸­ æˆ‘ä»¬åªç”¨åˆ°äº†ä¸€ä¸ªAPI

createStoreï¼šè¿™ä¸ªAPIæ¥å—reduceræ–¹æ³•ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªstoreï¼Œä¸»è¦åŠŸèƒ½éƒ½åœ¨è¿™ä¸ªstoreä¸Šã€‚

çœ‹çœ‹storeä¸Šæˆ‘ä»¬éƒ½ç”¨åˆ°äº†å•¥ï¼š

store.subscribe: è®¢é˜…stateçš„å˜åŒ–ï¼Œå½“stateå˜åŒ–çš„æ—¶å€™æ‰§è¡Œå›è°ƒï¼Œå¯ä»¥æœ‰å¤šä¸ªsubscribeï¼Œé‡Œé¢çš„å›è°ƒä¼šä¾æ¬¡æ‰§è¡Œã€‚

store.dispatch: å‘å‡ºactionçš„æ–¹æ³•ï¼Œæ¯æ¬¡dispatch actionéƒ½ä¼šæ‰§è¡Œreducerç”Ÿæˆæ–°çš„stateï¼Œç„¶åæ‰§è¡Œsubscribeæ³¨å†Œçš„å›è°ƒã€‚

store.getState:ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œè¿”å›å½“å‰çš„stateã€‚

çœ‹åˆ°subscribeæ³¨å†Œå›è°ƒï¼Œdispatchè§¦å‘å›è°ƒ. è¿™å°±æ˜¯å…¸å‹çš„å‘å¸ƒè®¢é˜…æ¨¡å¼.åé¢èŠèŠå‘å¸ƒè®¢é˜…æ¨¡å¼.

```js
function createStore() {
  let state;              // stateè®°å½•æ‰€æœ‰çŠ¶æ€
  let listeners = [];     // ä¿å­˜æ‰€æœ‰æ³¨å†Œçš„å›è°ƒ

  function subscribe(callback) {
    listeners.push(callback);       // subscribeå°±æ˜¯å°†å›è°ƒä¿å­˜ä¸‹æ¥
  }

  // dispatchå°±æ˜¯å°†æ‰€æœ‰çš„å›è°ƒæ‹¿å‡ºæ¥ä¾æ¬¡æ‰§è¡Œå°±è¡Œ

  function dispatch(action) {
    /**
    * reducerçš„ä½œç”¨æ˜¯åœ¨å‘å¸ƒäº‹ä»¶çš„æ—¶å€™æ”¹å˜stateï¼Œ
    * æ‰€ä»¥æˆ‘ä»¬çš„dispatchåœ¨æ‰§è¡Œå›è°ƒå‰åº”è¯¥å…ˆæ‰§è¡Œreducer,
    * ç”¨reducerçš„è¿”å›å€¼é‡æ–°ç»™stateèµ‹å€¼
    */
    state = reducer(state, action);
    // æ”¹å˜çŠ¶æ€åæ‰§è¡Œè®¢é˜…çš„callback
    for (let i = 0; i < listeners.length; i++) {
      const listener = listeners[i];
      listener();
    }
  }
  // getStateç›´æ¥è¿”å›state
  function getState() {
    return state;
  }

  // storeåŒ…è£…ä¸€ä¸‹å‰é¢çš„æ–¹æ³•ç›´æ¥è¿”å›
  const store = {
    subscribe,
    dispatch,
    getState
  }

  return store;
}
```


### API:combineReducers

combineReducersä¹Ÿæ˜¯ä½¿ç”¨éå¸¸å¹¿æ³›çš„APIï¼Œå½“æˆ‘ä»¬åº”ç”¨è¶Šæ¥è¶Šå¤æ‚ï¼Œå¦‚æœå°†æ‰€æœ‰é€»è¾‘éƒ½å†™åœ¨ä¸€ä¸ªreduceré‡Œé¢ï¼Œæœ€ç»ˆè¿™ä¸ªæ–‡ä»¶å¯èƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡è¡Œï¼Œæ‰€ä»¥Reduxæä¾›äº†combineReducersï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸ºä¸åŒçš„æ¨¡å—å†™è‡ªå·±çš„reducerï¼Œæœ€ç»ˆå°†ä»–ä»¬ç»„åˆèµ·æ¥ã€‚æ¯”å¦‚æˆ‘ä»¬æœ€å¼€å§‹é‚£ä¸ªç‰›å¥¶ä»“åº“ï¼Œç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡å‘å±•å¾ˆå¥½ï¼Œæˆ‘ä»¬åˆå¢åŠ äº†ä¸€ä¸ªæ”¾å¤§ç±³çš„ä»“åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¿™ä¸¤ä¸ªä»“åº“åˆ›å»ºè‡ªå·±çš„reducer

```js
import { createStore, combineReducers } from 'redux';

const initMilkState = {
  milk: 0
};
function milkReducer(state = initMilkState, action) {
  switch (action.type) {
    case 'PUT_MILK':
      return {...state, milk: state.milk + action.count};
    case 'TAKE_MILK':
      return {...state, milk: state.milk - action.count};
    default:
      return state;
  }
}

const initRiceState = {
  rice: 0
};
function riceReducer(state = initRiceState, action) {
  switch (action.type) {
    case 'PUT_RICE':
      return {...state, rice: state.rice + action.count};
    case 'TAKE_RICE':
      return {...state, rice: state.rice - action.count};
    default:
      return state;
  }
}

// ä½¿ç”¨combineReducersç»„åˆä¸¤ä¸ªreducer
const reducer = combineReducers({milkState: milkReducer, riceState: riceReducer});

let store = createStore(reducer);

store.subscribe(() => console.log(store.getState()));

// æ“ä½œğŸ¥›çš„action
store.dispatch({ type: 'PUT_MILK', count: 1 });    // milk: 1
store.dispatch({ type: 'PUT_MILK', count: 1 });    // milk: 2
store.dispatch({ type: 'TAKE_MILK', count: 1 });   // milk: 1

// æ“ä½œå¤§ç±³çš„action
store.dispatch({ type: 'PUT_RICE', count: 1 });    // rice: 1
store.dispatch({ type: 'PUT_RICE', count: 1 });    // rice: 2
store.dispatch({ type: 'TAKE_RICE', count: 1 });   // rice: 1
```


åœ¨ä¸Šé¢ æˆ‘ä»¬æ–°å»ºäº†ä¸¤ä¸ªstateï¼Œé€šè¿‡combineReducersæ¥æ”¶è¿™ä¸¤ä¸ªreducerå¹¶è¿”å›ä¸€ä¸ªæ–°çš„reducerã€‚è®©æˆ‘ä»¬å°è¯•å®ç°ä¸€ä¸‹ï¼š

```js
function combineReducers(reducerMap) {
  const reducerKeys = Object.keys(reducerMap);    // å…ˆæŠŠå‚æ•°é‡Œé¢æ‰€æœ‰çš„é”®å€¼æ‹¿å‡ºæ¥
  
  // è¿”å›å€¼æ˜¯ä¸€ä¸ªæ™®é€šç»“æ„çš„reducerå‡½æ•°
  const reducer = (state = {}, action) => {
    const newState = {};
    
    for(let i = 0; i < reducerKeys.length; i++) {
      // reducerMapé‡Œé¢æ¯ä¸ªé”®çš„å€¼éƒ½æ˜¯ä¸€ä¸ªreducerï¼Œæˆ‘ä»¬æŠŠå®ƒæ‹¿å‡ºæ¥è¿è¡Œä¸‹å°±å¯ä»¥å¾—åˆ°å¯¹åº”é”®æ–°çš„stateå€¼
      // ç„¶åå°†æ‰€æœ‰reducerè¿”å›çš„stateæŒ‰ç…§å‚æ•°é‡Œé¢çš„keyç»„è£…å¥½
      // æœ€åå†è¿”å›ç»„è£…å¥½çš„newStateå°±è¡Œ
      const key = reducerKeys[i];
      const currentReducer = reducerMap[key];
      const prevState = state[key];
      newState[key] = currentReducer(prevState, action);
    }
    
    return newState;
  };
  
  return reducer;
}
```

### API:applyMiddleware
middlewareæ˜¯Reduxé‡Œé¢å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒReduxçš„ç”Ÿæ€ä¸»è¦é è¿™ä¸ªAPIæ¥å…¥ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³å†™ä¸€ä¸ªloggerçš„ä¸­é—´ä»¶å¯ä»¥è¿™æ ·å†™(è¿™ä¸ªä¸­é—´ä»¶æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£)ï¼š

```js
// loggeræ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ³¨æ„è¿”å›å€¼åµŒäº†å¥½å‡ å±‚å‡½æ•°
// æˆ‘ä»¬åé¢æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡
function logger(store) {
  return function(next) {
    return function(action) {
      console.group(action.type);
      console.info('dispatching', action);
      let result = next(action);
      console.log('next state', store.getState());
      console.groupEnd();
      return result
    }
  }
}

// åœ¨createStoreçš„æ—¶å€™å°†applyMiddlewareä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ è¿›å»
const store = createStore(
  reducer,
  applyMiddleware(logger)
)
```

åœ¨è¿™é‡ŒcreateStoreä¼ å…¥äº†ç¬¬äºŒä¸ªå‚æ•° å®˜æ–¹ç®¡è¿™ä¸ªå«åš enhancer ï¼Œenhancerä½œä¸ºä¸€ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªstoreCreaterå¹¶è¿”å›ä¸€ä¸ªstoreCreaterã€‚

è®©æˆ‘ä»¬æ›´æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„createStoreä½¿ä¹‹å¯ä»¥å¤„ç†ç¬¬äºŒä¸ªå‚æ•° ä¹Ÿå°±æ˜¯enhancerã€‚

```js

function createStore(reducer, enhancer) {   // æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•°enhancer
  // å…ˆå¤„ç†enhancer
  // å¦‚æœenhancerå­˜åœ¨å¹¶ä¸”æ˜¯å‡½æ•°
  // æˆ‘ä»¬å°†createStoreä½œä¸ºå‚æ•°ä¼ ç»™ä»–
  // ä»–åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„createStoreç»™æˆ‘
  // æˆ‘å†æ‹¿è¿™ä¸ªæ–°çš„createStoreæ‰§è¡Œï¼Œåº”è¯¥å¾—åˆ°ä¸€ä¸ªstore
  // ç›´æ¥è¿”å›è¿™ä¸ªstoreå°±è¡Œ
  if(enhancer && typeof enhancer === 'function'){
    const newCreateStore = enhancer(createStore);
    const newStore = newCreateStore(reducer);
    return newStore;
  }
  
  // å¦‚æœæ²¡æœ‰enhanceræˆ–è€…enhancerä¸æ˜¯å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œä¹‹å‰çš„é€»è¾‘
  // ä¸‹é¢è¿™äº›ä»£ç éƒ½æ˜¯ä¹‹å‰é‚£ç‰ˆ
  // çœç•¥nè¡Œä»£ç 
	// .......
  const store = {
    subscribe,
    dispatch,
    getState
  }

  return store;
}

```
-----

æœ€åæˆ‘ä»¬å†æ¥æ¢³ç†ä¸‹Reduxçš„æ ¸å¿ƒæµç¨‹ï¼Œæ³¨æ„å•çº¯çš„Reduxåªæ˜¯ä¸ªçŠ¶æ€æœºï¼Œæ˜¯æ²¡æœ‰Viewå±‚çš„ã€‚

<img src="../img/2020-10/redux-data-flow.png" />





## redux,react-redux
å•çº¯çš„Reduxåªæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œæ˜¯æ²¡æœ‰UIå‘ˆç°çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™éƒ½ä¼šé…åˆä¸€ä¸ªUIåº“ï¼Œæ¯”å¦‚åœ¨Reactä¸­ä½¿ç”¨Reduxå°±ä¼šç”¨åˆ°React-Reduxè¿™ä¸ªåº“ã€‚è¿™ä¸ªåº“çš„ä½œç”¨æ˜¯å°†Reduxçš„çŠ¶æ€æœºå’ŒReactçš„UIå‘ˆç°ç»‘å®šåœ¨ä¸€èµ·ï¼Œå½“ä½ dispatch actionæ”¹å˜stateçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æ›´æ–°é¡µé¢ã€‚æœ¬æ–‡è¿˜æ˜¯ä»å®ƒçš„åŸºæœ¬ä½¿ç”¨å…¥æ‰‹æ¥è‡ªå·±å†™ä¸€ä¸ªReact-Reduxï¼Œç„¶åæ›¿æ¢å®˜æ–¹çš„NPMåº“ï¼Œå¹¶ä¿æŒåŠŸèƒ½ä¸€è‡´ã€‚


react-redux çš„ç”¨æ³•
```js

import React from 'react';
import { connect } from 'react-redux';
import { increment, decrement, reset } from './actions';

function Counter(props) {
  const { 
    count,
    incrementHandler,
    decrementHandler,
    resetHandler
   } = props;

  return (
    <>
      <h3>Count: {count}</h3>
      <button onClick={incrementHandler}>è®¡æ•°+1</button>
      <button onClick={decrementHandler}>è®¡æ•°-1</button>
      <button onClick={resetHandler}>é‡ç½®</button>
    </>
  );
}

const mapStateToProps = (state) => {
  return {
    count: state.count
  }
}

const mapDispatchToProps = (dispatch) => {
  return {
    incrementHandler: () => dispatch(increment()),
    decrementHandler: () => dispatch(decrement()),
    resetHandler: () => dispatch(reset()),
  }
};

export default connect(
  mapStateToProps,
  mapDispatchToProps
)(Counter)

```

react-redux æ ¸å¿ƒapi:

1. Provider: ç”¨æ¥åŒ…è£¹æ ¹ç»„ä»¶çš„ç»„ä»¶ï¼Œä½œç”¨æ˜¯æ³¨å…¥Reduxçš„storeã€‚

2. connectï¼šç”¨æ¥å°†stateå’Œdispatchæ³¨å…¥ç»™éœ€è¦çš„ç»„ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–°ç»„ä»¶ï¼Œä»–å…¶å®æ˜¯ä¸ªé«˜é˜¶ç»„ä»¶ã€‚

React-Reduxçš„Providerå…¶å®å°±æ˜¯åŒ…è£…äº†[Context.Provider](https://react.html.cn/docs/context.html#contextprovider)ï¼Œè€Œä¼ é€’çš„å‚æ•°å°±æ˜¯redux storeï¼Œè€ŒReact-Reduxçš„connectHOCå…¶å®å°±æ˜¯åŒ…è£…çš„Context.Consumeræˆ–è€…useContext

å‡å¦‚æ²¡æœ‰è¿™ä¸¤ä¸ªAPIï¼Œåªç”¨Reduxå¯ä»¥å—ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼å…¶å®æˆ‘ä»¬ç”¨Reduxçš„ç›®çš„ä¸å°±æ˜¯å¸Œæœ›ç”¨å®ƒå°†æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€éƒ½ä¿å­˜ä¸‹æ¥ï¼Œæ¯æ¬¡æ“ä½œåªç”¨dispatch actionå»æ›´æ–°çŠ¶æ€ï¼Œç„¶åUIå°±è‡ªåŠ¨æ›´æ–°äº†å—ï¼Ÿé‚£æˆ‘ä»æ ¹ç»„ä»¶å¼€å§‹ï¼Œæ¯ä¸€çº§éƒ½æŠŠstoreä¼ ä¸‹å»ä¸å°±è¡Œäº†å—ï¼Ÿæ¯ä¸ªå­ç»„ä»¶éœ€è¦è¯»å–çŠ¶æ€çš„æ—¶å€™ï¼Œç›´æ¥ç”¨store.getState()å°±è¡Œäº†ï¼Œæ›´æ–°çŠ¶æ€çš„æ—¶å€™å°±store.dispatchï¼Œè¿™æ ·å…¶å®ä¹Ÿèƒ½è¾¾åˆ°ç›®çš„ã€‚ä½†æ˜¯ï¼Œä¸ä¼˜é›…ã€‚

è€Œstateæ˜¯ç»„ä»¶ä¸­å¯è‡ªè¡Œç®¡ç†çš„çŠ¶æ€ï¼Œè¿™æ„å‘³ç€Reactå¹¶æ²¡æœ‰è®©æ•°æ®å›æº¯çš„èƒ½åŠ›ï¼Œæ•°æ®åªèƒ½å•å‘å‘ä¸‹åˆ†å‘ï¼Œæˆ–è€…è‡ªè¡Œå†…éƒ¨å¤„ç†.

æ‰€ä»¥æœ€å¥½æœ‰ä¸ªä¸œè¥¿èƒ½å¤Ÿå°†storeå…¨å±€çš„æ³¨å…¥ç»„ä»¶æ ‘ï¼Œè€Œä¸éœ€è¦ä¸€å±‚å±‚ä½œä¸ºpropsä¼ é€’ï¼Œè¿™ä¸ªä¸œè¥¿å°±æ˜¯Provider.




### Provider
Context.js
```js
import React from 'react';

const ReactReduxContext = React.createContext();

export default ReactReduxContext;
```
Provider.js
```js
import React from 'react';
import ReactReduxContext from './Context';

function Provider(props) {
  const {store, children} = props;

  // è¿™æ˜¯è¦ä¼ é€’çš„context
  const contextValue = { store };

  // è¿”å›ReactReduxContextåŒ…è£¹çš„ç»„ä»¶ï¼Œä¼ å…¥contextValue
  // é‡Œé¢çš„å†…å®¹å°±ç›´æ¥æ˜¯childrenï¼Œæˆ‘ä»¬ä¸åŠ¨ä»–
  return (
    <ReactReduxContext.Provider value={contextValue}>
      {children}
    </ReactReduxContext.Provider>
  )
}

```


### connect


##### connenctå¹¶ä¸ä¼šæ”¹å˜å®ƒâ€œè¿æ¥â€çš„ç»„ä»¶ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªç»è¿‡åŒ…è£¹çš„connectç»„ä»¶ã€‚ conenctæ¥å—4ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯mapStateToPropsï¼ŒmapDispatchToPropsï¼ŒmergePropsï¼Œoptions(ä½¿ç”¨æ—¶æ³¨æ„å‚æ•°ä½ç½®é¡ºåº)ã€‚

```js
import React, { useContext } from 'react';
import ReactReduxContext from './Context';

function childPropsSelector(store, wrapperProps) {
  const state = store.getState();   // æ‹¿åˆ°state

  // æ‰§è¡ŒmapStateToPropså’ŒmapDispatchToProps
  const stateProps = mapStateToProps(state);
  const dispatchProps = mapDispatchToProps(store.dispatch);

  return Object.assign({}, stateProps, dispatchProps, wrapperProps);
}


// ç¬¬ä¸€å±‚å‡½æ•°æ¥æ”¶mapStateToPropså’ŒmapDispatchToProps
function connect(mapStateToProps, mapDispatchToProps) {
  // ç¬¬äºŒå±‚å‡½æ•°æ˜¯ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œé‡Œé¢è·å–context 
  // ç„¶åæ‰§è¡ŒmapStateToPropså’ŒmapDispatchToProps
  // å†å°†è¿™ä¸ªç»“æœç»„åˆç”¨æˆ·çš„å‚æ•°ä½œä¸ºæœ€ç»ˆå‚æ•°æ¸²æŸ“WrappedComponent
  // WrappedComponentå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨connextåŒ…è£¹çš„è‡ªå·±çš„ç»„ä»¶
  return function connectHOC(WrappedComponent) {

    function ConnectFunction(props) {
      // å¤åˆ¶ä¸€ä»½propsåˆ°wrapperProps
      const { ...wrapperProps } = props;
      const context = useContext(ReactReduxContext);
      const { store } = context;
      const actualChildProps = childPropsSelector(store, wrapperProps)
      // æ¸²æŸ“WrappedComponent
      return <WrappedComponent {...actualChildProps}></WrappedComponent>
    }
    return ConnectFunction;
  }
}

export default connect;

```


è¿™ä¸ªæ—¶å€™å·²ç»å¯ä»¥æ¸²æŸ“é¡µé¢äº† ä½†æ˜¯å½“æˆ‘ä»¬æ›´æ–°store
é¡µé¢è¿˜ä¸èƒ½è‡ªåŠ¨åˆ·æ–°
æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹storeæ³¨å†Œå›è°ƒ


```js
store.subscribe(() => {
  const newChildProps = childPropsSelector(store, wrapperProps);
  // å¦‚æœå‚æ•°å˜äº†ï¼Œè®°å½•æ–°çš„å€¼åˆ°lastChildPropsä¸Š
  // å¹¶ä¸”å¼ºåˆ¶æ›´æ–°å½“å‰ç»„ä»¶
  // shallowEqual æµ…æ¯”è¾ƒ
  if(!shallowEqual(newChildProps, lastChildProps.current)) {
    lastChildProps.current = newChildProps;

    // éœ€è¦ä¸€ä¸ªAPIæ¥å¼ºåˆ¶æ›´æ–°å½“å‰ç»„ä»¶
  }
});




```


```js
mport React, { useContext, useRef, useLayoutEffect, useReducer } from 'react';
import ReactReduxContext from './Context';
import shallowEqual from './shallowEqual';
import Subscription from './Subscription';

function storeStateUpdatesReducer(count) {
  return count + 1;
}

function connect(
  mapStateToProps = () => {}, 
  mapDispatchToProps = () => {}
  ) {
  function childPropsSelector(store, wrapperProps) {
    const state = store.getState();   // æ‹¿åˆ°state

    // æ‰§è¡ŒmapStateToPropså’ŒmapDispatchToProps
    const stateProps = mapStateToProps(state);
    const dispatchProps = mapDispatchToProps(store.dispatch);

    return Object.assign({}, stateProps, dispatchProps, wrapperProps);
  }

  return function connectHOC(WrappedComponent) {
    function ConnectFunction(props) {
      const { ...wrapperProps } = props;

      const contextValue = useContext(ReactReduxContext);

      const { store, subscription: parentSub } = contextValue;  // è§£æ„å‡ºstoreå’ŒparentSub
      
      const actualChildProps = childPropsSelector(store, wrapperProps);

      const lastChildProps = useRef();
      useLayoutEffect(() => {
        lastChildProps.current = actualChildProps;
      }, [actualChildProps]);

      const [
        ,
        forceComponentUpdateDispatch
      ] = useReducer(storeStateUpdatesReducer, 0)

      // æ–°å»ºä¸€ä¸ªsubscriptionå®ä¾‹
      const subscription = new Subscription(store, parentSub);

      // stateå›è°ƒæŠ½å‡ºæ¥æˆä¸ºä¸€ä¸ªæ–¹æ³•
      const checkForUpdates = () => {
        const newChildProps = childPropsSelector(store, wrapperProps);
        // å¦‚æœå‚æ•°å˜äº†ï¼Œè®°å½•æ–°çš„å€¼åˆ°lastChildPropsä¸Š
        // å¹¶ä¸”å¼ºåˆ¶æ›´æ–°å½“å‰ç»„ä»¶
        if(!shallowEqual(newChildProps, lastChildProps.current)) {
          lastChildProps.current = newChildProps;

          // éœ€è¦ä¸€ä¸ªAPIæ¥å¼ºåˆ¶æ›´æ–°å½“å‰ç»„ä»¶
          forceComponentUpdateDispatch();

          // ç„¶åé€šçŸ¥å­çº§æ›´æ–°
          subscription.notifyNestedSubs();
        }
      };

      // ä½¿ç”¨subscriptionæ³¨å†Œå›è°ƒ
      subscription.onStateChange = checkForUpdates;
      subscription.trySubscribe();

      // ä¿®æ”¹ä¼ ç»™å­çº§çš„context
      // å°†subscriptionæ›¿æ¢ä¸ºè‡ªå·±çš„
      const overriddenContextValue = {
        ...contextValue,
        subscription
      }

      // æ¸²æŸ“WrappedComponent
      // å†æ¬¡ä½¿ç”¨ReactReduxContextåŒ…è£¹ï¼Œä¼ å…¥ä¿®æ”¹è¿‡çš„context
      return (
        <ReactReduxContext.Provider value={overriddenContextValue}>
          <WrappedComponent {...actualChildProps} />
        </ReactReduxContext.Provider>
      )
    }

    return ConnectFunction;
  }
}

export default connect;

```


æºç ä¸­è¿˜æœ‰å¾ˆå¤šä»£ç   å¤§éƒ¨åˆ†æ˜¯ä½¿ç”¨Subscriptionç±»è‡ªå·±ç®¡ç†äº†ä¸€å¥—é€šçŸ¥æµç¨‹,ä¿è¯çˆ¶å­æ›´æ–°é¡ºåºçš„. è¿™é‡Œå…ˆç•¥è¿‡ä¸è®²äº†....


æ€»ç»“: 
1. React-Reduxæ˜¯è¿æ¥Reactå’ŒReduxçš„åº“ï¼ŒåŒæ—¶ä½¿ç”¨äº†Reactå’ŒReduxçš„APIã€‚
2. React-Reduxä¸»è¦æ˜¯ä½¿ç”¨äº†Reactçš„context apiæ¥ä¼ é€’Reduxçš„storeã€‚
3. Providerçš„ä½œç”¨æ˜¯æ¥æ”¶Redux storeå¹¶å°†å®ƒæ”¾åˆ°contextä¸Šä¼ é€’ä¸‹å»ã€‚
4. connectçš„ä½œç”¨æ˜¯ä»Redux storeä¸­é€‰å–éœ€è¦çš„å±æ€§ä¼ é€’ç»™åŒ…è£¹çš„ç»„ä»¶ã€‚
5. connectä¼šè‡ªå·±åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œåˆ¤æ–­çš„ä¾æ®æ˜¯éœ€è¦çš„stateæ˜¯å¦å·²ç»å˜åŒ–äº†ã€‚
6. connectåœ¨åˆ¤æ–­æ˜¯å¦å˜åŒ–çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯æµ…æ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯åªæ¯”è¾ƒä¸€å±‚ï¼Œæ‰€ä»¥åœ¨mapStateToPropså’ŒmapDispatchToPropsä¸­ä¸è¦åå›å¤šå±‚åµŒå¥—çš„å¯¹è±¡ã€‚
7. ä¸ºäº†è§£å†³çˆ¶ç»„ä»¶å’Œå­ç»„ä»¶å„è‡ªç‹¬ç«‹ä¾èµ–Reduxï¼Œç ´åäº†Reactçš„çˆ¶çº§->å­çº§çš„æ›´æ–°æµç¨‹ï¼ŒReact-Reduxä½¿ç”¨Subscriptionç±»è‡ªå·±ç®¡ç†äº†ä¸€å¥—é€šçŸ¥æµç¨‹ã€‚
8. åªæœ‰è¿æ¥åˆ°Reduxæœ€é¡¶çº§çš„ç»„ä»¶æ‰ä¼šç›´æ¥æ³¨å†Œåˆ°Redux storeï¼Œå…¶ä»–å­ç»„ä»¶éƒ½ä¼šæ³¨å†Œåˆ°æœ€è¿‘çˆ¶ç»„ä»¶çš„subscriptionå®ä¾‹ä¸Šã€‚
9. é€šçŸ¥çš„æ—¶å€™ä»æ ¹ç»„ä»¶å¼€å§‹ä¾æ¬¡é€šçŸ¥è‡ªå·±çš„å­ç»„ä»¶ï¼Œå­ç»„ä»¶æ¥æ”¶åˆ°é€šçŸ¥çš„æ—¶å€™ï¼Œå…ˆæ›´æ–°è‡ªå·±å†é€šçŸ¥è‡ªå·±çš„å­ç»„ä»¶ã€‚


å‘å¸ƒè®¢é˜…æ¨¡å¼
```js
var Event = (function() {
  var clientList = {};
      listen,
      trigger,
      remove;
  
  listen = function(key, fn) {
    if (!clientList[key]) {
      clientList[key] = [];
    }
    clientList[key].push(fn);
  };

  trigger = function() {
    var key = Array.prototype.shift.call(arguments),
        fns = clientList[key];
        if (!fns || fns.length === 0) {
          return false;
        }
        for (var i = 0, fn; fn = fns[i++];) {
          fn.apply(this, arguments);
        }
  };

  remove = function(key, fn) {
    var fns = clientList[key];
    if (!fns) {
      return false;
    }
    if (!fn) {
      fns && (fns.length = 0);
    } else {
      for (var l = fns.length - 1; l >= 0; l--) {
        var _fn = fns[l];
        if (_fn === fn) {
          fns.splice(l, 1);
        }
      }
    }
  };

  return {
    listen,
    trigger,
    remove,
  }
})();

Event.listen('squareMeter88', function(price) {
  console.log(`ä»·æ ¼${price}`);
})

Event.trigger('squareMeter88', 20000);


```
